<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dawnfire Dashboard</title>
    <link rel="stylesheet" href="src/styles/theme.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="app">
        <div style="
            padding: 40px;
            font-size: 24px;
            text-align: center;
            color: var(--text-secondary);
        ">
            ⏳ Loading dashboard configuration...
        </div>
    </div>

    <!-- Dashboard initialization with screensaver -->
    <script type="module">
        // Load config manager first
        import './src/config-manager.js';
        import { initializeDashboardRouter } from './src/dashboard-router.js';
        import { initScreensaver } from './src/components/screensaver/screensaver-controller.js';

        // Wait for config to be ready
        async function initializeDashboard() {
            try {
                console.log('Waiting for configuration...');
                
                // Give config manager time to initialize
                let retries = 0;
                while (!window.configManager.isReady() && retries < 30) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    retries++;
                }

                if (!window.configManager.isReady()) {
                    throw new Error('Configuration failed to load after 3 seconds');
                }

                console.log('✓ Configuration ready');
                window.configManager.debugStatus();

                // Initialize dashboard with time-based routing
                console.log('Initializing dashboard router...');
                const dashboardName = await initializeDashboardRouter();
                console.log(`✓ Dashboard loaded: ${dashboardName}`);

                // Initialize screensaver (3-hour idle, skips night dashboard)
                console.log('Initializing screensaver...');
                const screensaver = initScreensaver({
                    idleThreshold: 3 * 60 * 60 * 1000, // 3 hours
                });
                console.log('✓ Screensaver ready (triggers after 3 hours idle)');

            } catch (error) {
                console.error('Failed to initialize dashboard:', error);
                document.getElementById('app').innerHTML = `
                    <div style="
                        background: #ffe5e5;
                        color: #d20f39;
                        padding: 40px;
                        font-family: monospace;
                        font-size: 18px;
                        line-height: 1.6;
                        border-radius: 6px;
                    ">
                        <h1 style="margin-bottom: 20px;">⚠️ Dashboard Initialization Failed</h1>
                        <p style="margin-bottom: 20px;"><strong>Error:</strong> ${error.message}</p>
                        <hr style="border: none; border-top: 1px solid #d20f39; margin: 20px 0;">
                        <h3 style="margin-bottom: 10px;">Troubleshooting:</h3>
                        <p style="margin-bottom: 15px;"><strong>Local Development:</strong></p>
                        <pre style="background: #fff; padding: 10px; border-radius: 4px; overflow-x: auto;">cp .env.example .env
# Edit .env with your API keys and passwords
npm install
npm run dev:all
# Open http://localhost:5173</pre>
                        <p style="margin-top: 15px;"><strong>Production (K3s):</strong></p>
                        <pre style="background: #fff; padding: 10px; border-radius: 4px; overflow-x: auto;">kubectl logs -n dashboards deployment/morning-dashboard
# Check if init container created config.js</pre>
                        <p style="margin-top: 15px;">Check browser console (F12) for more details.</p>
                    </div>
                `;
            }
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeDashboard);
        } else {
            initializeDashboard();
        }
    </script>
</body>
</html>